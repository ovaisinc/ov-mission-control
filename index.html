<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ov Mission Control</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background: #0f0a0f; color: #e4e4e7; }
        .glass { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .client-card { transition: all 0.2s; cursor: pointer; }
        .client-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.08); }
        .tab-active { border-bottom: 2px solid #6366f1; color: #6366f1; }
        .progress-bar { background: rgba(255,255,255,0.1); border-radius: 999px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 999px; transition: width 0.3s; }
        .last-contact-green { color: #10b981; }
        .last-contact-yellow { color: #f59e0b; }
        .last-contact-red { color: #ef4444; }
        .no-scroll { overflow: hidden; }
        .drawing-overlay { position: fixed; inset: 0; background: rgba(6, 8, 16, 0.84); z-index: 60; display: flex; align-items: center; justify-content: center; padding: 16px; }
        .drawing-panel { width: min(980px, 96vw); max-height: 96vh; display: flex; flex-direction: column; gap: 12px; }
        .drawing-toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .tool-button { min-width: 44px; min-height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(17,24,39,0.7); color: #e5e7eb; padding: 0 12px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; }
        .tool-button.active { border-color: rgba(165,180,252,0.9); box-shadow: 0 0 0 1px rgba(165,180,252,0.5); }
        .drawing-canvas { background: #f8f8f8; border: 1px solid rgba(0,0,0,0.08); border-radius: 16px; width: 100%; height: 60vh; touch-action: none; }
        @media (min-width: 900px) { .drawing-canvas { width: 800px; height: 600px; } }
        .drawing-modal-body { display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .drawing-preview-img { max-width: 100%; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); background: white; }
        .image-overlay { position: fixed; inset: 0; background: rgba(6, 8, 16, 0.9); z-index: 70; display: flex; align-items: center; justify-content: center; padding: 16px; }
        .image-panel { width: min(1100px, 96vw); max-height: 96vh; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // ALL CLIENTS & ROLES
        const clientsData = [
            { 
                id: "face", name: "FACE Amusement", revenue: 3700, color: "#6366f1", isLegacy: true,
                brand: "Ov Theory (Legacy)", lastContact: "2 days ago", contactStatus: "green", taskCategory: "FACE",
                progress: 65, tasksTotal: 12, tasksDone: 8,
                meetingNotes: "Tom needs agent workflow. 11 agents planned across 3 phases.",
                research: "Review Tracking MCP waiting on Google Business info",
                docs: ["AI Agent Implementation Blueprint", "MCP Server Development Guide"]
            },
            { 
                id: "adtime", name: "Adtime Marketing", revenue: 1600, color: "#f59e0b",
                brand: "", lastContact: "1 week ago", contactStatus: "yellow", taskCategory: "Adtime",
                progress: 40, tasksTotal: 8, tasksDone: 3,
                meetingNotes: "$550K check deposit scheduled. Invoice matching software in progress.",
                research: "Billboard software integration, labor law compliance",
                docs: ["Invoice Matching Research"]
            },
            { 
                id: "aft", name: "Almost Free Teeth", revenue: 3100, color: "#06b6d4",
                brand: "", lastContact: "3 days ago", contactStatus: "green", taskCategory: "AFT",
                progress: 75, tasksTotal: 6, tasksDone: 5,
                meetingNotes: "HIPAA compliance critical. Dental software project.",
                research: "HIPAA requirements for AI handling patient data",
                docs: ["HIPAA Compliance Checklist"]
            },
            { 
                id: "chohan", name: "Chohan", revenue: 0, color: "#ec4899", isInternal: true,
                brand: "AI Audits & Agents", lastContact: "Today", contactStatus: "green", taskCategory: "Chohan",
                progress: 30, tasksTotal: 15, tasksDone: 5,
                meetingNotes: "New company - AI audits, agent development. Building brand.",
                research: "Service offerings, pricing, target market",
                docs: ["AI Transformation Audit Template", "AI Audit Service Offerings"]
            },
            { 
                id: "abbvie", name: "AbbVie", revenue: 0, color: "#10b981", isEmployment: true,
                brand: "Employment", lastContact: "Yesterday", contactStatus: "green", taskCategory: "AbbVie",
                progress: 50, tasksTotal: 10, tasksDone: 5,
                meetingNotes: "Ross submissions ongoing. Day job.",
                research: "",
                docs: []
            },
            { 
                id: "jamaat", name: "Chicago Jamaat", revenue: 0, color: "#8b5cf6", isCommunity: true,
                brand: "Motamid Role", lastContact: "Today", contactStatus: "green", taskCategory: "Jamaat",
                progress: 20, tasksTotal: 5, tasksDone: 1,
                meetingNotes: "Motamid report due TONIGHT. Follow up with Jazib & Fahad.",
                research: "",
                docs: []
            },
        ];
        
        // ALL TASKS
        const allTasks = [
            { id: 1, title: "Submit Motamid report", category: "Jamaat", priority: "high", due: "Tonight", done: false },
            { id: 2, title: "Follow up with Jazib & Fahad", category: "Jamaat", priority: "high", due: "Tonight", done: false },
            { id: 3, title: "Deposit $550K check", category: "Adtime", priority: "high", due: "Today", done: false },
            { id: 4, title: "Send Tom agent workflow", category: "FACE", priority: "high", due: "Today", done: false },
            { id: 5, title: "Ross submission - batch 1", category: "AbbVie", priority: "medium", due: "This week", done: true },
            { id: 6, title: "Ross submission - batch 2", category: "AbbVie", priority: "medium", due: "This week", done: false },
            { id: 7, title: "Review FACE phase 1 agents", category: "FACE", priority: "medium", due: "Tomorrow", done: false },
            { id: 8, title: "HIPAA compliance review", category: "AFT", priority: "high", due: "This week", done: false },
            { id: 9, title: "Chohan service offerings doc", category: "Chohan", priority: "medium", due: "This week", done: false },
            { id: 10, title: "Update invoicing system", category: "Adtime", priority: "low", due: "Next week", done: false },
        ];
        
        // EMERGENCY PREP (SHTF) LIST
        const emergencyItems = [
            { id: 1, item: "3-day water supply (1 gal/person/day)", category: "Supplies", priority: "critical", done: true },
            { id: 2, item: "Water purification tablets", category: "Supplies", priority: "high", done: true },
            { id: 3, item: "30-day non-perishable food", category: "Supplies", priority: "critical", done: false },
            { id: 4, item: "Manual can opener", category: "Supplies", priority: "high", done: true },
            { id: 5, item: "First aid kit + medications", category: "Supplies", priority: "critical", done: true },
            { id: 6, item: "Prescription meds (30-day)", category: "Supplies", priority: "critical", done: false },
            { id: 7, item: "Flashlights + batteries", category: "Supplies", priority: "critical", done: true },
            { id: 8, item: "Battery-powered radio", category: "Supplies", priority: "high", done: true },
            { id: 9, item: "Power bank (fully charged)", category: "Supplies", priority: "high", done: true },
            { id: 10, item: "Solar/crank charger", category: "Supplies", priority: "medium", done: false },
            { id: 11, item: "Cash ($500-1000 small bills)", category: "Financial", priority: "critical", done: false },
            { id: 12, item: "Important docs (copies)", category: "Documents", priority: "critical", done: true },
            { id: 13, item: "Emergency contacts list", category: "Network", priority: "critical", done: true },
            { id: 14, item: "Whistle (3 blasts = help)", category: "Skills", priority: "high", done: true },
            { id: 15, item: "Fire extinguisher", category: "Supplies", priority: "critical", done: true },
            { id: 16, item: "Dust masks", category: "Supplies", priority: "medium", done: false },
            { id: 17, item: "Multi-tool / Swiss Army", category: "Supplies", priority: "high", done: true },
            { id: 18, item: "Duct tape", category: "Supplies", priority: "medium", done: true },
            { id: 19, item: "Plastic sheeting", category: "Supplies", priority: "medium", done: false },
            { id: 20, item: "Sleeping bags/blankets", category: "Supplies", priority: "high", done: true },
            { id: 21, item: "Personal hygiene items", category: "Supplies", priority: "medium", done: true },
            { id: 22, item: "Bleach (sanitization)", category: "Supplies", priority: "medium", done: false },
            { id: 23, item: "Family emergency plan", category: "Documents", priority: "critical", done: false },
        ];
        
        // PERSONAL TASKS
        const personalTasks = [
            { id: 1, title: "Email Kris from Village back", category: "Personal", priority: "high", done: false, type: "personal" },
            { id: 2, title: "Order food prep stuff", category: "Personal", priority: "medium", done: false, type: "personal" },
            { id: 3, title: "Schedule dentist appointment", category: "Personal", priority: "high", done: false, type: "personal" },
            { id: 4, title: "Take cholesterol test", category: "Personal", priority: "high", done: false, type: "personal" },
            { id: 5, title: "Pay Schaumburg ticket", category: "Personal", priority: "critical", done: false, type: "personal" },
        ];
        
        const STORAGE_KEYS = {
            tasks: "ovmc_tasks",
            personal: "ovmc_personal",
            emergency: "ovmc_emergency",
            completed: "ovmc_completed",
            notes: "ovmc_notes",
            noteDraft: "ovmc_notes_draft",
            noteTag: "ovmc_notes_tag",
            noteLinkedTo: "ovmc_notes_linked_to",
            personalGoals: "ovmc_personal_goals",
        };
        
        const loadFromStorage = (key, fallback) => {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return fallback;
                const parsed = JSON.parse(raw);
                if (Array.isArray(fallback)) {
                    return Array.isArray(parsed) ? parsed : fallback;
                }
                if (fallback && typeof fallback === "object") {
                    return parsed && typeof parsed === "object" ? parsed : fallback;
                }
                return parsed ?? fallback;
            } catch (err) {
                return fallback;
            }
        };
        
        const buildInitialTaskState = () => {
            const rawTasks = loadFromStorage(STORAGE_KEYS.tasks, allTasks);
            const rawPersonal = loadFromStorage(STORAGE_KEYS.personal, personalTasks);
            const storedCompleted = loadFromStorage(STORAGE_KEYS.completed, []);
            const completed = Array.isArray(storedCompleted) ? [...storedCompleted] : [];

            const splitActive = (items, type) => {
                const active = [];
                items.forEach(item => {
                    if (item.done) {
                        completed.push({ ...item, type });
                    } else {
                        active.push(item);
                    }
                });
                return active;
            };

            return {
                activeTasks: splitActive(rawTasks, "business"),
                activePersonal: splitActive(rawPersonal, "personal"),
                completed,
            };
        };

        const normalizeStoredNote = (note) => ({
            id: note.id || Date.now() + Math.random(),
            timestamp: note.timestamp || new Date().toISOString(),
            type: note.type || "text",
            content: note.content || "",
            drawingData: note.drawingData || null,
            tag: note.tag || "",
            linkedTo: note.linkedTo ?? null,
        });

        const migrateLegacyNotes = () => {
            const storedNotes = loadFromStorage(STORAGE_KEYS.notes, null);
            if (Array.isArray(storedNotes)) return storedNotes.map(note => normalizeStoredNote(note));

            const legacyPersonal = loadFromStorage("ovmc_personal_notes", []);
            const legacyClientNotes = loadFromStorage("ovmc_client_notes", null);
            const migrated = [];

            if (Array.isArray(legacyPersonal)) {
                legacyPersonal.forEach(note => {
                    migrated.push({
                        id: note.id || Date.now() + Math.random(),
                        timestamp: note.timestamp || new Date().toISOString(),
                        type: "text",
                        content: note.content || "",
                        tag: note.tag || "",
                        linkedTo: "personal",
                    });
                });
            }

            if (legacyClientNotes && typeof legacyClientNotes === "object") {
                Object.entries(legacyClientNotes).forEach(([clientId, content]) => {
                    if ((content || "").trim()) {
                        migrated.push({
                            id: Date.now() + Math.random(),
                            timestamp: new Date().toISOString(),
                            type: "text",
                            content: String(content),
                            tag: "",
                            linkedTo: clientId,
                        });
                    }
                });
            }

            return migrated;
        };
        
        function App() {
            const [activeTab, setActiveTab] = useState("dashboard");
            const [selectedClient, setSelectedClient] = useState(null);
            const [detailTab, setDetailTab] = useState("overview");
            const [quickTaskText, setQuickTaskText] = useState("");
            const [personalTaskText, setPersonalTaskText] = useState("");
            const [personalTaskDue, setPersonalTaskDue] = useState("none");
            const initialTaskState = useMemo(() => buildInitialTaskState(), []);
            const [tasks, setTasks] = useState(initialTaskState.activeTasks);
            const [personal, setPersonal] = useState(initialTaskState.activePersonal);
            const [completedTasks, setCompletedTasks] = useState(initialTaskState.completed);
            const [emergency, setEmergency] = useState(() => loadFromStorage(STORAGE_KEYS.emergency, emergencyItems));
            const [searchTerm, setSearchTerm] = useState("");
            const [notes, setNotes] = useState(() => migrateLegacyNotes());
            const [noteDraft, setNoteDraft] = useState(() => loadFromStorage(STORAGE_KEYS.noteDraft, ""));
            const [noteTag, setNoteTag] = useState(() => loadFromStorage(STORAGE_KEYS.noteTag, ""));
            const [noteLinkedTo, setNoteLinkedTo] = useState(() => loadFromStorage(STORAGE_KEYS.noteLinkedTo, null));
            const [personalGoals, setPersonalGoals] = useState(() => loadFromStorage(STORAGE_KEYS.personalGoals, []));
            const [goalText, setGoalText] = useState("");
            const [taskFilter, setTaskFilter] = useState("all");
            const [clientFilter, setClientFilter] = useState(clientsData[0]?.taskCategory || "");
            const [expandedPrepCategory, setExpandedPrepCategory] = useState(null);
            const [showCompleted, setShowCompleted] = useState(false);
            const [noteFilter, setNoteFilter] = useState("all");
            const [noteMode, setNoteMode] = useState("text");
            const [showDrawingModal, setShowDrawingModal] = useState(false);
            const [drawingTool, setDrawingTool] = useState("black");
            const [drawingLinkedTo, setDrawingLinkedTo] = useState(null);
            const [drawingTag, setDrawingTag] = useState("");
            const [expandedDrawing, setExpandedDrawing] = useState(null);
            const canvasRef = useRef(null);
            const ctxRef = useRef(null);
            const strokesRef = useRef([]);
            const currentStrokeRef = useRef(null);
            
            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.tasks, JSON.stringify(tasks));
            }, [tasks]);
            
            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.personal, JSON.stringify(personal));
            }, [personal]);
            
            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.emergency, JSON.stringify(emergency));
            }, [emergency]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.completed, JSON.stringify(completedTasks));
            }, [completedTasks]);
            
            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.notes, JSON.stringify(notes));
            }, [notes]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.noteDraft, noteDraft);
            }, [noteDraft]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.noteTag, noteTag);
            }, [noteTag]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.noteLinkedTo, JSON.stringify(noteLinkedTo));
            }, [noteLinkedTo]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.personalGoals, JSON.stringify(personalGoals));
            }, [personalGoals]);
            
            const toggleTask = (id, list, setList) => {
                setList(list.map(t => t.id === id ? { ...t, done: !t.done } : t));
            };

            const completeTask = (task, type) => {
                if (type === "business") {
                    setTasks(prev => prev.filter(t => t.id !== task.id));
                } else {
                    setPersonal(prev => prev.filter(t => t.id !== task.id));
                }
                setCompletedTasks(prev => [{ ...task, done: true, type }, ...prev]);
            };

            const restoreTask = (task) => {
                setCompletedTasks(prev => prev.filter(t => !(t.id === task.id && t.type === task.type)));
                if (task.type === "business") {
                    const { type, ...rest } = task;
                    setTasks(prev => [{ ...rest, done: false }, ...prev]);
                } else {
                    setPersonal(prev => [{ ...task, done: false, type: "personal" }, ...prev]);
                }
            };
            
            const mergedTasks = [
                ...tasks.map(t => ({ ...t, type: "business" })),
                ...personal.map(t => ({ ...t, type: "personal" })),
            ];
            
            const matchesSearch = (task) => {
                const term = searchTerm.trim().toLowerCase();
                if (!term) return true;
                const fields = [task.title, task.category, task.type];
                return fields.some(field => (field || "").toLowerCase().includes(term));
            };
            
            const matchesFilter = (task) => {
                if (taskFilter === "business") return task.type === "business";
                if (taskFilter === "personal") return task.type === "personal";
                if (taskFilter === "client") return task.type === "business" && task.category === clientFilter;
                return true;
            };
            
            const filteredTasks = mergedTasks.filter(task => matchesSearch(task) && matchesFilter(task));
            const filteredCompleted = completedTasks
                .filter(task => matchesSearch(task) && matchesFilter(task))
                .map(task => ({ ...task, type: task.type || "business" }));
            
            const totalRev = clientsData.reduce((sum, c) => sum + c.revenue, 0);
            const totalProfit = totalRev * 0.75; // ~75% profit margin
            const pendingTasks = tasks.filter(t => !t.done).length + personal.filter(t => !t.done).length;
            const emergencyDone = emergency.filter(e => e.done).length;
            const emergencyProgress = (emergencyDone / emergency.length) * 100;
            const emergencyCategories = [
                { id: "Financial", label: "Financial", bar: "bg-emerald-500", accent: "text-emerald-300" },
                { id: "Supplies", label: "Supplies", bar: "bg-cyan-500", accent: "text-cyan-300" },
                { id: "Documents", label: "Documents", bar: "bg-amber-500", accent: "text-amber-300" },
                { id: "Skills", label: "Skills", bar: "bg-indigo-500", accent: "text-indigo-300" },
                { id: "Network", label: "Network", bar: "bg-pink-500", accent: "text-pink-300" },
            ];
            const emergencyCategoryData = emergencyCategories.map(category => {
                const items = emergency.filter(item => item.category === category.id);
                const done = items.filter(item => item.done).length;
                const total = items.length;
                const progress = total > 0 ? Math.round((done / total) * 100) : 0;
                return { ...category, items, done, total, progress };
            });
            
            const getContactClass = (status) => {
                if (status === "green") return "last-contact-green";
                if (status === "yellow") return "last-contact-yellow";
                return "last-contact-red";
            };
            
            const getClientColor = (category) => {
                const client = clientsData.find(c => c.taskCategory.toLowerCase() === (category || "").toLowerCase());
                return client?.color || "#6b7280";
            };

            const openClient = (client) => {
                setSelectedClient(client);
                setDetailTab("overview");
            };

            const addQuickTask = () => {
                if (!selectedClient) return;
                const title = quickTaskText.trim();
                if (!title) return;
                const newTask = {
                    id: Date.now(),
                    title,
                    category: selectedClient.taskCategory,
                    priority: "medium",
                    due: "This week",
                    done: false,
                };
                setTasks(prev => [newTask, ...prev]);
                setQuickTaskText("");
            };

            const addPersonalTask = () => {
                const title = personalTaskText.trim();
                if (!title) return;
                const dueLabel = personalTaskDue === "today" ? "Today" : personalTaskDue === "tonight" ? "Tonight" : "";
                const newTask = {
                    id: Date.now(),
                    title,
                    category: "Personal",
                    priority: "medium",
                    due: dueLabel,
                    done: false,
                    type: "personal",
                };
                setPersonal(prev => [newTask, ...prev]);
                setPersonalTaskText("");
                setPersonalTaskDue("none");
            };

            const drawingTools = {
                black: { label: "Black", color: "#111111", baseWidth: 2.6 },
                blue: { label: "Blue", color: "#2563eb", baseWidth: 2.6 },
                red: { label: "Red", color: "#dc2626", baseWidth: 2.6 },
                eraser: { label: "Eraser", color: "#ffffff", baseWidth: 14 },
            };

            const getCanvasPoint = (event) => {
                const canvas = canvasRef.current;
                if (!canvas) return { x: 0, y: 0, pressure: 0.5 };
                const rect = canvas.getBoundingClientRect();
                const pressure = typeof event.pressure === "number" && event.pressure > 0 ? event.pressure : 0.5;
                return {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top,
                    pressure,
                };
            };

            const setupCanvas = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const rect = canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                canvas.width = Math.max(1, Math.floor(rect.width * dpr));
                canvas.height = Math.max(1, Math.floor(rect.height * dpr));
                const ctx = canvas.getContext("2d");
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                ctx.lineCap = "round";
                ctx.lineJoin = "round";
                ctxRef.current = ctx;
                redrawCanvas();
            };

            const drawStroke = (stroke) => {
                const ctx = ctxRef.current;
                if (!ctx || !stroke || stroke.points.length === 0) return;
                const points = stroke.points;
                if (points.length === 1) {
                    const point = points[0];
                    const width = stroke.baseWidth * (stroke.tool === "eraser" ? 1 : point.pressure);
                    ctx.fillStyle = stroke.color;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, Math.max(1, width / 2), 0, Math.PI * 2);
                    ctx.fill();
                    return;
                }
                for (let i = 1; i < points.length; i++) {
                    const prev = points[i - 1];
                    const curr = points[i];
                    const midX = (prev.x + curr.x) / 2;
                    const midY = (prev.y + curr.y) / 2;
                    const width = stroke.baseWidth * (stroke.tool === "eraser" ? 1 : curr.pressure);
                    ctx.strokeStyle = stroke.color;
                    ctx.lineWidth = Math.max(1, width);
                    ctx.beginPath();
                    ctx.moveTo(prev.x, prev.y);
                    ctx.quadraticCurveTo(prev.x, prev.y, midX, midY);
                    ctx.stroke();
                }
            };

            const redrawCanvas = () => {
                const ctx = ctxRef.current;
                const canvas = canvasRef.current;
                if (!ctx || !canvas) return;
                const rect = canvas.getBoundingClientRect();
                ctx.clearRect(0, 0, rect.width, rect.height);
                ctx.fillStyle = "#f8f8f8";
                ctx.fillRect(0, 0, rect.width, rect.height);
                strokesRef.current.forEach(stroke => drawStroke(stroke));
            };

            const startDrawing = (event) => {
                if (event.button !== undefined && event.button !== 0) return;
                const tool = drawingTools[drawingTool] || drawingTools.black;
                const point = getCanvasPoint(event);
                const stroke = {
                    id: Date.now() + Math.random(),
                    tool: drawingTool,
                    color: tool.color,
                    baseWidth: tool.baseWidth,
                    points: [point],
                };
                currentStrokeRef.current = stroke;
                const canvas = canvasRef.current;
                if (canvas?.setPointerCapture) {
                    canvas.setPointerCapture(event.pointerId);
                }
                drawStroke(stroke);
            };

            const continueDrawing = (event) => {
                if (!currentStrokeRef.current) return;
                const point = getCanvasPoint(event);
                currentStrokeRef.current.points.push(point);
                drawStroke(currentStrokeRef.current);
            };

            const endDrawing = (event) => {
                if (!currentStrokeRef.current) return;
                strokesRef.current = [...strokesRef.current, currentStrokeRef.current];
                currentStrokeRef.current = null;
                const canvas = canvasRef.current;
                if (canvas?.releasePointerCapture) {
                    try { canvas.releasePointerCapture(event.pointerId); } catch (err) {}
                }
            };

            const undoDrawing = () => {
                if (strokesRef.current.length === 0) return;
                strokesRef.current = strokesRef.current.slice(0, -1);
                redrawCanvas();
            };

            const clearDrawing = () => {
                strokesRef.current = [];
                redrawCanvas();
            };

            const openDrawingModal = (linkedToOverride) => {
                setDrawingLinkedTo(linkedToOverride ?? noteLinkedTo ?? null);
                setDrawingTag("");
                setDrawingTool("black");
                strokesRef.current = [];
                currentStrokeRef.current = null;
                setShowDrawingModal(true);
            };

            const closeDrawingModal = () => {
                setShowDrawingModal(false);
                currentStrokeRef.current = null;
            };

            const saveDrawingNote = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const dataUrl = canvas.toDataURL("image/png");
                if (!dataUrl) return;
                const newNote = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    type: "drawing",
                    content: "",
                    drawingData: dataUrl,
                    tag: drawingTag.trim() || "",
                    linkedTo: drawingLinkedTo ?? null,
                };
                setNotes(prev => [newNote, ...prev]);
                closeDrawingModal();
            };

            const addNote = (linkedToOverride) => {
                const content = noteDraft.trim();
                if (!content) return;
                const resolvedLinkedTo = linkedToOverride !== undefined ? linkedToOverride : noteLinkedTo;
                const newNote = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    type: "text",
                    content,
                    tag: noteTag.trim() || "",
                    linkedTo: resolvedLinkedTo ?? null,
                };
                setNotes(prev => [newNote, ...prev]);
                setNoteDraft("");
                setNoteTag("");
            };

            const updateNote = (id, updates) => {
                setNotes(prev => prev.map(note => note.id === id ? { ...note, ...updates } : note));
            };

            const addPersonalGoal = () => {
                const content = goalText.trim();
                if (!content) return;
                const newGoal = {
                    id: Date.now(),
                    text: content,
                    createdAt: new Date().toISOString(),
                };
                setPersonalGoals(prev => [newGoal, ...prev]);
                setGoalText("");
            };
            
            const resetData = () => {
                Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
                ["ovmc_personal_notes", "ovmc_client_notes", "ovmc_personal_note_draft", "ovmc_personal_note_tag"].forEach(key => localStorage.removeItem(key));
                const resetCompleted = [];
                const resetActiveTasks = [];
                const resetActivePersonal = [];
                allTasks.forEach(item => {
                    if (item.done) {
                        resetCompleted.push({ ...item, type: "business" });
                    } else {
                        resetActiveTasks.push(item);
                    }
                });
                personalTasks.forEach(item => {
                    if (item.done) {
                        resetCompleted.push({ ...item, type: "personal" });
                    } else {
                        resetActivePersonal.push(item);
                    }
                });
                setTasks(resetActiveTasks);
                setPersonal(resetActivePersonal);
                setEmergency(emergencyItems);
                setCompletedTasks(resetCompleted);
                setNotes([]);
                setNoteDraft("");
                setNoteTag("");
                setNoteLinkedTo(null);
                setPersonalGoals([]);
                setGoalText("");
                setPersonalTaskText("");
                setPersonalTaskDue("none");
                setSearchTerm("");
                setTaskFilter("all");
                setClientFilter(clientsData[0]?.taskCategory || "");
                setExpandedPrepCategory(null);
                setShowCompleted(false);
            };

            const clearCompleted = () => setCompletedTasks([]);

            const detailSections = [
                { id: "overview", label: "Overview" },
                { id: "tasks", label: "Tasks" },
                { id: "meetings", label: "Meetings" },
                { id: "notes", label: "Notes" },
                { id: "research", label: "Research" },
                { id: "files", label: "Files" },
                { id: "activity", label: "Activity" },
            ];

            const clientTasks = selectedClient
                ? tasks.filter(t => t.category.toLowerCase() === selectedClient.taskCategory.toLowerCase())
                : [];

            const clientMeetings = selectedClient ? [] : [];
            const clientActivity = selectedClient ? [] : [];

            const formatNoteTime = (iso) => {
                try {
                    return new Date(iso).toLocaleString();
                } catch (err) {
                    return iso;
                }
            };

            useEffect(() => {
                if (selectedClient?.id) {
                    setNoteLinkedTo(selectedClient.id);
                }
            }, [selectedClient?.id]);

            useEffect(() => {
                if (!showDrawingModal) return;
                document.body.classList.add("no-scroll");
                const handleResize = () => {
                    requestAnimationFrame(setupCanvas);
                };
                handleResize();
                window.addEventListener("resize", handleResize);
                return () => {
                    document.body.classList.remove("no-scroll");
                    window.removeEventListener("resize", handleResize);
                };
            }, [showDrawingModal]);

            const resolveNoteLinkLabel = (linkedTo) => {
                if (linkedTo === "personal") return "Personal";
                if (linkedTo === null || linkedTo === undefined || linkedTo === "") return "Global";
                const client = clientsData.find(c => c.id === linkedTo);
                return client ? client.name : "Client";
            };

            const notesSorted = [...notes].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const clientNotes = selectedClient ? notesSorted.filter(note => note.linkedTo === selectedClient.id) : [];
            const personalScopedNotes = notesSorted.filter(note => note.linkedTo === "personal" || note.linkedTo === null || note.linkedTo === undefined || note.linkedTo === "");
            const globalNotesFiltered = notesSorted.filter(note => {
                if (noteFilter === "linked") return note.linkedTo && note.linkedTo !== "personal";
                if (noteFilter === "personal") return note.linkedTo === "personal";
                if (noteFilter === "global") return note.linkedTo === null || note.linkedTo === undefined || note.linkedTo === "";
                return true;
            });
            
            return (
                <div className={selectedClient ? "w-full px-6 lg:px-10 py-6" : "max-w-7xl mx-auto p-6"}>
                    {/* HEADER */}
                    <div className="flex justify-between items-start mb-6">
                        <div>
                            <h1 className="text-4xl font-bold gradient-text mb-1">Ov Mission Control</h1>
                            <p className="text-gray-400">Complete Life & Business Dashboard</p>
                        </div>
                        <div className="text-right">
                            <div className="text-2xl font-bold text-green-400">${(totalRev/1000).toFixed(1)}k<span className="text-sm text-gray-500">/mo</span></div>
                            <div className="text-sm text-gray-500">${(totalProfit/1000).toFixed(1)}k profit</div>
                            <button
                                onClick={resetData}
                                className="mt-3 text-xs uppercase tracking-wide text-gray-400 hover:text-gray-200 border border-gray-700 px-3 py-1 rounded-full"
                            >
                                Reset Data
                            </button>
                        </div>
                    </div>
                    
                    {/* NAVIGATION */}
                    <div className="flex gap-6 border-b border-gray-800 mb-6 overflow-x-auto">
                        {["dashboard", "clients", "tasks", "personal", "notes", "emergency"].map(tab => (
                            <button
                                key={tab}
                                onClick={() => { setActiveTab(tab); setSelectedClient(null); }}
                                className={`pb-3 px-2 capitalize whitespace-nowrap ${activeTab === tab ? "tab-active" : "text-gray-500 hover:text-gray-300"}`}
                            >
                                {tab === "emergency" ? "Prep" : tab}
                            </button>
                        ))}
                    </div>
                    
                    {/* DASHBOARD TAB */}
                    {activeTab === "dashboard" && !selectedClient && (
                        <>
                            {/* STATS ROW */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div className="glass rounded-xl p-5">
                                    <div className="text-3xl font-bold text-indigo-400">{tasks.length}</div>
                                    <div className="text-sm text-gray-400">Business Tasks</div>
                                    <div className="text-xs text-red-400 mt-1">{pendingTasks} pending</div>
                                </div>
                                <div className="glass rounded-xl p-5">
                                    <div className="text-3xl font-bold text-amber-400">{personal.length}</div>
                                    <div className="text-sm text-gray-400">Personal Tasks</div>
                                    <div className="text-xs text-gray-500 mt-1">{personal.filter(t => !t.done).length} pending</div>
                                </div>
                                <div className="glass rounded-xl p-5">
                                    <div className="text-3xl font-bold text-green-400">${(totalRev * 12 / 1000).toFixed(0)}k</div>
                                    <div className="text-sm text-gray-400">Annual Revenue</div>
                                </div>
                                <div className="glass rounded-xl p-5">
                                    <div className="text-3xl font-bold text-purple-400">{emergencyDone}/{emergency.length}</div>
                                    <div className="text-sm text-gray-400">Emergency Prep</div>
                                    <div className="progress-bar mt-2 h-2">
                                        <div className="progress-fill bg-purple-500" style={{width: `${emergencyProgress}%`}}></div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* CLIENTS OVERVIEW */}
                            <h2 className="text-xl font-semibold mb-4">Clients & Roles</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                                {clientsData.map(client => (
                                    <div 
                                        key={client.id} 
                                        className="glass client-card rounded-xl p-5"
                                        style={{borderTop: `3px solid ${client.color}`}}
                                        onClick={() => openClient(client)}
                                    >
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="font-semibold text-lg">{client.name}</h3>
                                            <span className={`text-xs ${getContactClass(client.contactStatus)}`}>{client.lastContact}</span>
                                        </div>
                                        {client.brand && <span className="text-xs text-gray-500 block mb-2">{client.brand}</span>}
                                        {client.revenue > 0 && (
                                            <div className="text-green-400 font-semibold mb-2">${client.revenue.toLocaleString()}/mo</div>
                                        )}
                                        <div className="progress-bar h-2 mb-2">
                                            <div className="progress-fill" style={{width: `${client.progress}%`, background: client.color}}></div>
                                        </div>
                                        <div className="text-xs text-gray-500">{client.tasksDone}/{client.tasksTotal} tasks ‚Ä¢ Click for details ‚Üí</div>
                                    </div>
                                ))}
                            </div>
                            
                            {/* URGENT TASKS */}
                            <h2 className="text-xl font-semibold mb-4">Due Today/Tonight</h2>
                            <div className="glass rounded-xl divide-y divide-gray-800">
                                {tasks.filter(t => !t.done && (t.due === "Tonight" || t.due === "Today")).map(t => (
                                    <div key={t.id} className="p-4 flex items-center gap-3">
                                        <input 
                                            type="checkbox" 
                                            checked={t.done}
                                            onChange={() => completeTask(t, "business")}
                                            className="w-5 h-5 rounded border-gray-600 bg-gray-800"
                                        />
                                        <div className="flex-1">
                                            <div className="text-gray-200">{t.title}</div>
                                            <div className="flex gap-2 mt-1">
                                                <span className="text-xs bg-gray-800 px-2 py-1 rounded">{t.category}</span>
                                                <span className={`text-xs ${t.priority === "high" ? "text-red-400" : "text-yellow-400"}`}>{t.due}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {tasks.filter(t => !t.done && (t.due === "Tonight" || t.due === "Today")).length === 0 && (
                                    <div className="p-4 text-gray-500">No urgent tasks! üéâ</div>
                                )}
                            </div>
                        </>
                    )}
                    
                    {/* CLIENT DETAIL VIEW */}
                    {selectedClient && (
                        <div className="space-y-8">
                            <button 
                                onClick={() => { setSelectedClient(null); setActiveTab("clients"); }}
                                className="text-gray-400 hover:text-white flex items-center gap-2"
                            >
                                ‚Üê Back to Client List
                            </button>
                            
                            <div className="grid grid-cols-1 lg:grid-cols-[260px,1fr] xl:grid-cols-[280px,1fr] gap-8">
                                <div className="glass rounded-2xl p-5 h-fit sticky top-6">
                                    <div className="mb-5">
                                        <div className="text-xs uppercase tracking-widest text-gray-500">Client</div>
                                        <div className="text-xl font-semibold mt-1">{selectedClient.name}</div>
                                        {selectedClient.brand && <div className="text-sm text-gray-500 mt-1">{selectedClient.brand}</div>}
                                        <div className={`text-xs mt-2 ${getContactClass(selectedClient.contactStatus)}`}>Last contact: {selectedClient.lastContact}</div>
                                    </div>
                                    <div className="space-y-1">
                                        {detailSections.map(section => (
                                            <button
                                                key={section.id}
                                                onClick={() => setDetailTab(section.id)}
                                                className={`w-full text-left px-3 py-2 rounded-lg text-sm ${detailTab === section.id ? "bg-indigo-500/20 text-indigo-200 border border-indigo-500/30" : "text-gray-400 hover:text-gray-200 hover:bg-white/5"}`}
                                            >
                                                {section.label}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="mt-6 rounded-xl border border-gray-800 bg-black/30 p-4">
                                        <div className="text-xs text-gray-500">Revenue</div>
                                        {selectedClient.revenue > 0 ? (
                                            <div className="text-lg font-semibold text-green-400">${selectedClient.revenue.toLocaleString()}<span className="text-xs text-gray-500">/mo</span></div>
                                        ) : (
                                            <div className="text-xs text-gray-500">Tracked as needed</div>
                                        )}
                                        <div className="text-xs text-gray-500 mt-2">Progress</div>
                                        <div className="progress-bar h-2 mt-1">
                                            <div className="progress-fill" style={{width: `${selectedClient.progress}%`, background: selectedClient.color}}></div>
                                        </div>
                                    </div>
                                </div>

                                <div className="glass rounded-2xl p-8" style={{borderLeft: `4px solid ${selectedClient.color}`}}>
                                    <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-6 mb-8">
                                        <div>
                                            <h2 className="text-3xl font-bold">{detailSections.find(s => s.id === detailTab)?.label}</h2>
                                            <p className="text-gray-500 text-sm">Client workspace for {selectedClient.taskCategory}</p>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-xs uppercase tracking-widest text-gray-500">Tasks</div>
                                            <div className="text-xl font-semibold text-gray-200">{selectedClient.tasksDone}/{selectedClient.tasksTotal} complete</div>
                                        </div>
                                    </div>

                                    {detailTab === "overview" && (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                                                <div className="bg-black/20 rounded-2xl p-5">
                                                    <div className="text-xs text-gray-500 uppercase tracking-wide">Focus</div>
                                                    <div className="text-lg font-semibold mt-1">Current sprint</div>
                                                    <div className="text-sm text-gray-400 mt-2">Deliverables aligned to {selectedClient.taskCategory} milestones.</div>
                                                </div>
                                                <div className="bg-black/20 rounded-2xl p-5">
                                                    <div className="text-xs text-gray-500 uppercase tracking-wide">Pipeline</div>
                                                    <div className="text-lg font-semibold mt-1">{clientTasks.filter(t => !t.done).length} open tasks</div>
                                                    <div className="text-sm text-gray-400 mt-2">Next check-in: {selectedClient.lastContact}</div>
                                                </div>
                                                <div className="bg-black/20 rounded-2xl p-5">
                                                    <div className="text-xs text-gray-500 uppercase tracking-wide">Momentum</div>
                                                    <div className="text-lg font-semibold mt-1">{selectedClient.progress}% complete</div>
                                                    <div className="progress-bar h-2 mt-3">
                                                        <div className="progress-fill" style={{width: `${selectedClient.progress}%`, background: selectedClient.color}}></div>
                                                    </div>
                                                </div>
                                            </div>

                                            {selectedClient.meetingNotes && (
                                                <div className="bg-black/20 rounded-2xl p-5">
                                                    <div className="text-sm text-gray-400 mb-2">Latest meeting note</div>
                                                    <div className="text-gray-300">{selectedClient.meetingNotes}</div>
                                                </div>
                                            )}

                                            <div>
                                                <div className="text-sm text-gray-400 mb-3">Recent tasks</div>
                                                <div className="space-y-3">
                                                    {clientTasks.slice(0, 3).map(t => (
                                                        <div key={t.id} className="flex items-center gap-3 bg-black/20 rounded-xl p-4">
                                                            <div className={`w-2 h-2 rounded-full ${t.done ? "bg-green-400" : "bg-yellow-400"}`}></div>
                                                            <div className="flex-1">
                                                                <div className={t.done ? "line-through text-gray-600" : "text-gray-200"}>{t.title}</div>
                                                                <div className="text-xs text-gray-500 mt-1">{t.due}</div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {clientTasks.length === 0 && (
                                                        <div className="text-gray-500">No tasks for this client yet.</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {detailTab === "tasks" && (
                                        <div className="space-y-5">
                                            <div className="bg-black/20 rounded-2xl p-5 flex flex-col md:flex-row gap-4 md:items-center">
                                                <div className="flex-1">
                                                    <div className="text-sm text-gray-400 mb-2">Quick add</div>
                                                    <input
                                                        value={quickTaskText}
                                                        onChange={(e) => setQuickTaskText(e.target.value)}
                                                        onKeyDown={(e) => { if (e.key === "Enter") addQuickTask(); }}
                                                        placeholder={`Add a task for ${selectedClient.name}`}
                                                        className="w-full bg-black/30 border border-gray-700 rounded-xl px-4 py-3 text-gray-200 text-base"
                                                    />
                                                </div>
                                                <button
                                                    onClick={addQuickTask}
                                                    className="px-5 py-3 rounded-xl bg-indigo-500/20 text-indigo-200 border border-indigo-500/40 text-sm uppercase tracking-wide"
                                                >
                                                    Add Task
                                                </button>
                                            </div>
                                            <div className="space-y-3">
                                                {clientTasks.map(t => (
                                                    <div key={t.id} className="flex items-center gap-3 bg-black/20 rounded-xl p-4">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={t.done}
                                                            onChange={() => completeTask(t, "business")}
                                                            className="w-5 h-5 rounded border-gray-600 bg-gray-800"
                                                        />
                                                        <div className="flex-1">
                                                            <div className={t.done ? "line-through text-gray-600" : "text-gray-200"}>{t.title}</div>
                                                            <div className="flex gap-2 mt-1">
                                                                <span className="text-xs bg-gray-800 px-2 py-1 rounded">{t.priority}</span>
                                                                <span className="text-xs text-gray-500">{t.due}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                                {clientTasks.length === 0 && (
                                                    <div className="text-gray-500">No tasks for this client yet.</div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {detailTab === "meetings" && (
                                        <div className="space-y-4">
                                            {clientMeetings.map(meeting => (
                                                <div key={meeting.id} className="bg-black/20 rounded-2xl p-5">
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <div className="font-semibold text-gray-200">{meeting.title}</div>
                                                            <div className="text-xs text-gray-500 mt-1">{meeting.date}</div>
                                                        </div>
                                                        <span className={`text-xs uppercase tracking-wide ${meeting.status === "completed" ? "text-green-400" : "text-yellow-400"}`}>
                                                            {meeting.status}
                                                        </span>
                                                    </div>
                                                    <div className="text-sm text-gray-400 mt-3">{meeting.notes}</div>
                                                </div>
                                            ))}
                                            {clientMeetings.length === 0 && (
                                                <div className="bg-black/20 rounded-2xl p-5 text-gray-500">No meetings yet.</div>
                                            )}
                                        </div>
                                    )}

                                    {detailTab === "notes" && (
                                        <div className="space-y-5">
                                            <div className="bg-black/20 rounded-2xl p-5">
                                                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                                                    <div>
                                                        <div className="text-sm text-gray-400">Quick add</div>
                                                        <div className="text-xs text-gray-500">Linked to {selectedClient.name}</div>
                                                    </div>
                                                    <button
                                                        onClick={() => addNote(selectedClient.id)}
                                                        className="px-4 py-2 rounded-xl bg-indigo-500/20 text-indigo-200 border border-indigo-500/40 text-xs uppercase tracking-wide"
                                                    >
                                                        Save Note
                                                    </button>
                                                </div>
                                                <div className="space-y-3">
                                                    <input
                                                        value={noteTag}
                                                        onChange={(e) => setNoteTag(e.target.value)}
                                                        placeholder="Tag (optional)"
                                                        className="w-full bg-black/30 border border-gray-700 rounded-xl px-4 py-3 text-gray-200"
                                                    />
                                                    <textarea
                                                        value={noteDraft}
                                                        onChange={(e) => setNoteDraft(e.target.value)}
                                                        rows="6"
                                                        className="w-full bg-black/30 border border-gray-700 rounded-2xl p-4 text-gray-200 text-base"
                                                        placeholder={`Capture a note for ${selectedClient.name}...`}
                                                    />
                                                </div>
                                            </div>
                                            <div className="space-y-4">
                                                {clientNotes.map(note => (
                                                    <div key={note.id} className="bg-black/20 rounded-2xl p-4 space-y-3">
                                                        <div className="flex items-center justify-between text-xs text-gray-500">
                                                            <span>{formatNoteTime(note.timestamp)}</span>
                                                            <span className="px-2 py-1 rounded-full bg-indigo-500/20 text-indigo-200 border border-indigo-500/30">Client</span>
                                                        </div>
                                                        <input
                                                            value={note.tag || ""}
                                                            onChange={(e) => updateNote(note.id, { tag: e.target.value })}
                                                            placeholder="Tag"
                                                            className="w-full bg-black/30 border border-gray-700 rounded-xl px-3 py-2 text-gray-200 text-sm"
                                                        />
                                                        <textarea
                                                            value={note.content}
                                                            onChange={(e) => updateNote(note.id, { content: e.target.value })}
                                                            rows="5"
                                                            className="w-full bg-black/30 border border-gray-700 rounded-2xl p-4 text-gray-200 text-base"
                                                        />
                                                    </div>
                                                ))}
                                                {clientNotes.length === 0 && (
                                                    <div className="text-gray-500">No notes linked to this client yet.</div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {detailTab === "research" && (
                                        <div className="space-y-4">
                                            {selectedClient.research && (
                                                <div className="bg-black/20 rounded-2xl p-5">
                                                    <div className="text-sm text-gray-400 mb-2">Key research</div>
                                                    <div className="text-gray-300">{selectedClient.research}</div>
                                                </div>
                                            )}
                                            <div className="bg-black/20 rounded-2xl p-5 text-sm text-gray-400">
                                                Use the Notes section to capture linked updates, decisions, and follow-ups.
                                            </div>
                                        </div>
                                    )}

                                    {detailTab === "files" && (
                                        <div className="space-y-4">
                                            <div className="text-sm text-gray-400">Documents</div>
                                            <div className="border border-dashed border-gray-700 rounded-xl p-6 text-center text-gray-500 bg-black/20">
                                                Drop files here or click to upload (placeholder)
                                            </div>
                                            {selectedClient.docs.length > 0 && (
                                                <div className="flex flex-wrap gap-2">
                                                    {selectedClient.docs.map((doc, i) => (
                                                        <span key={i} className="text-xs bg-gray-800 px-3 py-1 rounded-full">{doc}</span>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {detailTab === "activity" && (
                                        <div className="space-y-4">
                                            {clientActivity.map(item => (
                                                <div key={item.id} className="flex gap-3">
                                                    <div className="flex flex-col items-center">
                                                        <div className="w-2 h-2 rounded-full bg-indigo-400 mt-2"></div>
                                                        <div className="flex-1 w-px bg-gray-800"></div>
                                                    </div>
                                                    <div className="bg-black/20 rounded-2xl p-5 flex-1">
                                                        <div className="text-xs text-gray-500">{item.time}</div>
                                                        <div className="text-gray-200 mt-1">{item.text}</div>
                                                    </div>
                                                </div>
                                            ))}
                                            {clientActivity.length === 0 && (
                                                <div className="bg-black/20 rounded-2xl p-5 text-gray-500">No activity yet.</div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* CLIENTS LIST TAB */}
                    {activeTab === "clients" && !selectedClient && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {clientsData.map(client => (
                                <div 
                                    key={client.id} 
                                    className="glass client-card rounded-xl p-5"
                                    style={{borderLeft: `4px solid ${client.color}`}}
                                    onClick={() => openClient(client)}
                                >
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="font-semibold text-lg">{client.name}</h3>
                                            {client.brand && <p className="text-sm text-gray-500">{client.brand}</p>}
                                        </div>
                                        <span className={`text-sm ${getContactClass(client.contactStatus)}`}>{client.lastContact}</span>
                                    </div>
                                    {client.revenue > 0 && (
                                        <div className="text-green-400 font-semibold mt-2">${client.revenue.toLocaleString()}/mo</div>
                                    )}
                                    <div className="mt-3">
                                        <div className="flex justify-between text-sm text-gray-500 mb-1">
                                            <span>Progress</span>
                                            <span>{client.progress}%</span>
                                        </div>
                                        <div className="progress-bar h-2">
                                            <div className="progress-fill" style={{width: `${client.progress}%`, background: client.color}}></div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {/* TASKS TAB */}
                    {activeTab === "tasks" && (
                        <>
                            <div className="flex flex-col lg:flex-row lg:items-center gap-3 mb-6">
                                <div className="flex gap-2 flex-wrap">
                                    {[
                                        { id: "all", label: "All" },
                                        { id: "business", label: "Business" },
                                        { id: "personal", label: "Personal" },
                                        { id: "client", label: "By Client" },
                                    ].map(filter => (
                                        <button
                                            key={filter.id}
                                            onClick={() => setTaskFilter(filter.id)}
                                            className={`px-3 py-1 rounded-full text-xs uppercase tracking-wide ${taskFilter === filter.id ? "bg-indigo-500/20 text-indigo-300 border border-indigo-500/40" : "bg-gray-800 text-gray-400 border border-gray-800 hover:text-gray-200"}`}
                                        >
                                            {filter.label}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex-1 flex flex-col sm:flex-row gap-3">
                                    {taskFilter === "client" && (
                                        <select
                                            value={clientFilter}
                                            onChange={(e) => setClientFilter(e.target.value)}
                                            className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm"
                                        >
                                            {clientsData.map(client => (
                                                <option key={client.id} value={client.taskCategory}>{client.name}</option>
                                            ))}
                                        </select>
                                    )}
                                    <input
                                        type="text"
                                        placeholder="Search tasks..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2"
                                    />
                                </div>
                            </div>
                            <div className="glass rounded-xl divide-y divide-gray-800">
                                {filteredTasks.map(t => (
                                    <div
                                        key={`${t.type}-${t.id}`}
                                        className="p-4 flex items-center gap-3 border-l-2"
                                        style={{ borderColor: t.type === "business" ? getClientColor(t.category) : "#f472b6" }}
                                    >
                                        <input 
                                            type="checkbox" 
                                            checked={t.done}
                                            onChange={() => completeTask(t, t.type)}
                                            className="w-5 h-5 rounded border-gray-600 bg-gray-800"
                                        />
                                        <div className="flex-1">
                                            <div className={t.done ? "line-through text-gray-600" : "text-gray-200"}>{t.title}</div>
                                            <div className="flex gap-2 mt-1">
                                                {t.type === "business" ? (
                                                    <>
                                                        <span
                                                            className="text-xs px-2 py-1 rounded-full border"
                                                            style={{ borderColor: getClientColor(t.category), color: getClientColor(t.category), background: "rgba(15, 23, 42, 0.4)" }}
                                                        >
                                                            {t.category}
                                                        </span>
                                                        <span className={`text-xs ${t.priority === "high" ? "text-red-400" : t.priority === "medium" ? "text-yellow-400" : "text-gray-400"}`}>{t.priority}</span>
                                                        <span className="text-xs text-gray-500">{t.due}</span>
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="text-xs px-2 py-1 rounded-full bg-pink-500/20 text-pink-300 border border-pink-500/40">Personal</span>
                                                        <span className="text-xs text-gray-500">{t.category}</span>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {filteredTasks.length === 0 && (
                                    <div className="p-4 text-gray-500">No tasks match this view.</div>
                                )}
                            </div>
                            <div className="flex flex-wrap items-center gap-3 mt-4">
                                <button
                                    onClick={() => setShowCompleted(prev => !prev)}
                                    className="text-xs uppercase tracking-wide text-gray-400 hover:text-gray-200 border border-gray-700 px-3 py-1 rounded-full"
                                >
                                    {showCompleted ? "Hide Completed" : `Show Completed (${filteredCompleted.length})`}
                                </button>
                                <button
                                    onClick={clearCompleted}
                                    disabled={completedTasks.length === 0}
                                    className={`text-xs uppercase tracking-wide border px-3 py-1 rounded-full ${completedTasks.length === 0 ? "border-gray-800 text-gray-600 cursor-not-allowed" : "border-gray-700 text-gray-400 hover:text-gray-200"}`}
                                >
                                    Clear Completed
                                </button>
                            </div>
                            {showCompleted && (
                                <div className="glass rounded-xl divide-y divide-gray-800 mt-4">
                                    {filteredCompleted.map(t => (
                                        <div
                                            key={`completed-${t.type}-${t.id}`}
                                            className="p-3 flex items-center gap-3 border-l-2 text-sm opacity-70"
                                            style={{ borderColor: t.type === "business" ? getClientColor(t.category) : "#f472b6" }}
                                        >
                                            <input 
                                                type="checkbox" 
                                                checked={true}
                                                onChange={() => restoreTask(t)}
                                                className="w-4 h-4 rounded border-gray-600 bg-gray-800"
                                            />
                                            <div className="flex-1">
                                                <div className="line-through text-gray-500">{t.title}</div>
                                                <div className="flex gap-2 mt-1">
                                                    {t.type === "business" ? (
                                                        <>
                                                            <span
                                                                className="text-[10px] px-2 py-0.5 rounded-full border"
                                                                style={{ borderColor: getClientColor(t.category), color: getClientColor(t.category), background: "rgba(15, 23, 42, 0.4)" }}
                                                            >
                                                                {t.category}
                                                            </span>
                                                            {t.priority && (
                                                                <span className="text-[10px] text-gray-500">{t.priority}</span>
                                                            )}
                                                            {t.due && (
                                                                <span className="text-[10px] text-gray-600">{t.due}</span>
                                                            )}
                                                        </>
                                                    ) : (
                                                        <>
                                                            <span className="text-[10px] px-2 py-0.5 rounded-full bg-pink-500/10 text-pink-300 border border-pink-500/30">Personal</span>
                                                            <span className="text-[10px] text-gray-600">{t.category}</span>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {filteredCompleted.length === 0 && (
                                        <div className="p-4 text-gray-500 text-sm">No completed tasks in this view.</div>
                                    )}
                                </div>
                            )}
                        </>
                    )}
                    
                    {/* EMERGENCY PREP TAB */}
                    {activeTab === "emergency" && (
                        <>
                            <div className="glass rounded-xl p-4 mb-6">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-gray-400">Emergency Preparedness Progress</span>
                                    <span className="font-bold text-purple-400">{emergencyDone}/{emergency.length}</span>
                                </div>
                                <div className="progress-bar h-3">
                                    <div className="progress-fill bg-purple-500" style={{width: `${emergencyProgress}%`}}></div>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {emergencyCategoryData.map(category => (
                                    <div key={category.id} className="glass rounded-xl p-4">
                                        <button
                                            onClick={() => setExpandedPrepCategory(expandedPrepCategory === category.id ? null : category.id)}
                                            className="w-full text-left"
                                        >
                                            <div className="flex justify-between items-center mb-3">
                                                <div>
                                                    <h3 className="font-semibold text-gray-200">{category.label}</h3>
                                                    <div className="text-xs text-gray-500">{category.done}/{category.total} complete</div>
                                                </div>
                                                <div className={`text-lg font-semibold ${category.accent}`}>{category.progress}%</div>
                                            </div>
                                            <div className="progress-bar h-2">
                                                <div className={`progress-fill ${category.bar}`} style={{width: `${category.progress}%`}}></div>
                                            </div>
                                        </button>
                                        {expandedPrepCategory === category.id && (
                                            <div className="mt-4 space-y-2">
                                                {category.items.map(item => (
                                                    <label key={item.id} className="flex items-center gap-2 text-sm text-gray-300">
                                                        <input
                                                            type="checkbox"
                                                            checked={item.done}
                                                            onChange={() => toggleTask(item.id, emergency, setEmergency)}
                                                            className="w-4 h-4 rounded border-gray-600 bg-gray-800"
                                                        />
                                                        <span className={item.done ? "line-through text-gray-600" : ""}>{item.item}</span>
                                                    </label>
                                                ))}
                                                {category.items.length === 0 && (
                                                    <div className="text-xs text-gray-500">No items in this category yet.</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </>
                    )}

                    {/* NOTES TAB */}
                    {activeTab === "notes" && (
                        <div className="grid grid-cols-1 xl:grid-cols-[1.2fr,1fr] gap-6">
                            <div className="glass rounded-2xl p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h2 className="text-2xl font-semibold">Notes</h2>
                                        <p className="text-sm text-gray-500">Universal notes system with optional client links.</p>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button
                                            onClick={() => setNoteMode("text")}
                                            className={`px-4 py-2 rounded-xl text-xs uppercase tracking-wide ${noteMode === "text" ? "bg-indigo-500/30 text-indigo-100 border border-indigo-500/60" : "bg-gray-800 text-gray-300 border border-gray-700"}`}
                                        >
                                            Write Note
                                        </button>
                                        <button
                                            onClick={() => { setNoteMode("drawing"); openDrawingModal(); }}
                                            className={`px-4 py-2 rounded-xl text-xs uppercase tracking-wide ${noteMode === "drawing" ? "bg-indigo-500/30 text-indigo-100 border border-indigo-500/60" : "bg-gray-800 text-gray-300 border border-gray-700"}`}
                                        >
                                            Draw Note
                                        </button>
                                    </div>
                                </div>
                                <div className="space-y-3">
                                    <select
                                        value={noteLinkedTo ?? ""}
                                        onChange={(e) => {
                                            const value = e.target.value;
                                            setNoteLinkedTo(value === "" ? null : value);
                                        }}
                                        className="w-full bg-black/30 border border-gray-700 rounded-xl px-4 py-3 text-gray-200"
                                    >
                                        <option value="">Global (no link)</option>
                                        <option value="personal">Personal</option>
                                        {clientsData.map(client => (
                                            <option key={client.id} value={client.id}>{client.name}</option>
                                        ))}
                                    </select>
                                    <input
                                        value={noteTag}
                                        onChange={(e) => setNoteTag(e.target.value)}
                                        placeholder="Tag (optional)"
                                        className="w-full bg-black/30 border border-gray-700 rounded-xl px-4 py-3 text-gray-200"
                                    />
                                    <textarea
                                        value={noteDraft}
                                        onChange={(e) => setNoteDraft(e.target.value)}
                                        rows="10"
                                        className="w-full bg-black/30 border border-gray-700 rounded-2xl p-4 text-gray-200 text-base"
                                        placeholder="Start typing... notes are saved as you type."
                                    />
                                    <button
                                        onClick={() => addNote()}
                                        className="w-full px-4 py-3 rounded-xl bg-indigo-500/20 text-indigo-200 border border-indigo-500/40 text-sm uppercase tracking-wide"
                                    >
                                        Save Note
                                    </button>
                                </div>
                            </div>
                            <div className="glass rounded-2xl p-6">
                                <div className="flex flex-wrap items-center gap-2 mb-4">
                                    {[
                                        { id: "all", label: "All" },
                                        { id: "linked", label: "Linked to Clients" },
                                        { id: "personal", label: "Personal Only" },
                                        { id: "global", label: "Global" },
                                    ].map(filter => (
                                        <button
                                            key={filter.id}
                                            onClick={() => setNoteFilter(filter.id)}
                                            className={`px-3 py-1 rounded-full text-xs uppercase tracking-wide ${noteFilter === filter.id ? "bg-indigo-500/20 text-indigo-300 border border-indigo-500/40" : "bg-gray-800 text-gray-400 border border-gray-800 hover:text-gray-200"}`}
                                        >
                                            {filter.label}
                                        </button>
                                    ))}
                                </div>
                                <div className="space-y-4">
                                    {globalNotesFiltered.map(note => (
                                        <div key={note.id} className="bg-black/20 rounded-2xl p-4">
                                            <div className="flex items-center justify-between text-xs text-gray-500 mb-2">
                                                <span>{formatNoteTime(note.timestamp)}</span>
                                                <span className="px-2 py-1 rounded-full bg-gray-800 text-gray-300 border border-gray-700">{resolveNoteLinkLabel(note.linkedTo)}</span>
                                            </div>
                                            {note.tag && <div className="text-xs text-indigo-200 mb-2">{note.tag}</div>}
                                            {note.type === "drawing" ? (
                                                <div className="space-y-2">
                                                    <button
                                                        onClick={() => setExpandedDrawing(note)}
                                                        className="w-full"
                                                    >
                                                        <img
                                                            src={note.drawingData}
                                                            alt="Drawing note"
                                                            className="w-full max-h-56 object-contain rounded-xl border border-white/10 bg-white"
                                                        />
                                                    </button>
                                                    <div className="text-xs text-gray-400">Linked to: {resolveNoteLinkLabel(note.linkedTo)}</div>
                                                </div>
                                            ) : (
                                                <div className="text-gray-200 whitespace-pre-wrap">{note.content}</div>
                                            )}
                                        </div>
                                    ))}
                                    {globalNotesFiltered.length === 0 && (
                                        <div className="text-gray-500">No notes in this filter yet.</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* PERSONAL TAB */}
                    {activeTab === "personal" && (
                        <div className="space-y-6">
                            <div className="grid grid-cols-1 xl:grid-cols-[1.1fr,1fr] gap-6">
                                <div className="glass rounded-2xl p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <div>
                                            <h2 className="text-2xl font-semibold">Tasks</h2>
                                            <p className="text-sm text-gray-500">Personal backlog with quick add.</p>
                                        </div>
                                    </div>
                                    <div className="bg-black/20 rounded-2xl p-4 mb-5">
                                        <div className="text-xs text-gray-500 uppercase tracking-wide mb-2">Quick add</div>
                                        <div className="flex flex-col md:flex-row gap-3">
                                            <input
                                                value={personalTaskText}
                                                onChange={(e) => setPersonalTaskText(e.target.value)}
                                                onKeyDown={(e) => { if (e.key === "Enter") addPersonalTask(); }}
                                                placeholder="Add a personal task"
                                                className="flex-1 bg-black/30 border border-gray-700 rounded-xl px-4 py-3 text-gray-200 text-base"
                                            />
                                            <select
                                                value={personalTaskDue}
                                                onChange={(e) => setPersonalTaskDue(e.target.value)}
                                                className="bg-black/30 border border-gray-700 rounded-xl px-3 py-3 text-sm text-gray-300"
                                            >
                                                <option value="none">No due</option>
                                                <option value="today">Today</option>
                                                <option value="tonight">Tonight</option>
                                            </select>
                                            <button
                                                onClick={addPersonalTask}
                                                className="px-4 py-3 rounded-xl bg-pink-500/20 text-pink-200 border border-pink-500/40 text-sm uppercase tracking-wide"
                                            >
                                                Add
                                            </button>
                                        </div>
                                    </div>
                                    <div className="space-y-3">
                                        {personal.map(t => (
                                            <div key={t.id} className="flex items-center gap-3 bg-black/20 rounded-xl p-4">
                                                <input 
                                                    type="checkbox" 
                                                    checked={t.done}
                                                    onChange={() => completeTask(t, "personal")}
                                                    className="w-5 h-5 rounded border-gray-600 bg-gray-800"
                                                />
                                                <div className="flex-1">
                                                    <div className={t.done ? "line-through text-gray-600" : "text-gray-200"}>{t.title}</div>
                                                    <div className="flex gap-2 mt-1">
                                                        <span className="text-xs text-gray-500">{t.category}</span>
                                                        {t.due && <span className="text-xs text-gray-400">{t.due}</span>}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {personal.length === 0 && (
                                            <div className="text-gray-500">No personal tasks yet.</div>
                                        )}
                                    </div>
                                </div>

                                <div className="glass rounded-2xl p-6">
                                    <h2 className="text-2xl font-semibold mb-4">Today</h2>
                                    <div className="space-y-3">
                                        {personal.filter(t => t.due === "Today" || t.due === "Tonight").map(t => (
                                            <div key={t.id} className="bg-black/20 rounded-xl p-4">
                                                <div className="text-sm text-gray-200">{t.title}</div>
                                                <div className="text-xs text-gray-500 mt-1">{t.due}</div>
                                            </div>
                                        ))}
                                        {personal.filter(t => t.due === "Today" || t.due === "Tonight").length === 0 && (
                                            <div className="text-gray-500">No personal tasks due today.</div>
                                        )}
                                    </div>
                                    <div className="mt-6 border-t border-gray-800 pt-5">
                                        <h3 className="text-lg font-semibold mb-3">Goals & Reminders</h3>
                                        <div className="flex gap-3 mb-4">
                                            <input
                                                value={goalText}
                                                onChange={(e) => setGoalText(e.target.value)}
                                                onKeyDown={(e) => { if (e.key === "Enter") addPersonalGoal(); }}
                                                placeholder="Add a goal or reminder"
                                                className="flex-1 bg-black/30 border border-gray-700 rounded-xl px-4 py-3 text-gray-200"
                                            />
                                            <button
                                                onClick={addPersonalGoal}
                                                className="px-4 py-3 rounded-xl bg-emerald-500/20 text-emerald-200 border border-emerald-500/40 text-sm uppercase tracking-wide"
                                            >
                                                Add
                                            </button>
                                        </div>
                                        <div className="space-y-2">
                                            {personalGoals.map(goal => (
                                                <div key={goal.id} className="bg-black/20 rounded-xl p-3 text-sm text-gray-200">
                                                    {goal.text}
                                                </div>
                                            ))}
                                            {personalGoals.length === 0 && (
                                                <div className="text-gray-500">No goals yet.</div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="glass rounded-2xl p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h2 className="text-2xl font-semibold">Notes</h2>
                                        <p className="text-sm text-gray-500">Personal and global notes.</p>
                                    </div>
                                    <button
                                        onClick={() => addNote("personal")}
                                        className="px-4 py-2 rounded-xl bg-indigo-500/20 text-indigo-200 border border-indigo-500/40 text-sm uppercase tracking-wide"
                                    >
                                        Save Note
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-[1.1fr,1fr] gap-5">
                                    <div className="space-y-3">
                                        <div className="text-xs text-gray-500 uppercase tracking-wide">Quick add</div>
                                        <input
                                            value={noteTag}
                                            onChange={(e) => setNoteTag(e.target.value)}
                                            placeholder="Tag (optional)"
                                            className="w-full bg-black/30 border border-gray-700 rounded-xl px-4 py-3 text-gray-200"
                                        />
                                        <textarea
                                            value={noteDraft}
                                            onChange={(e) => setNoteDraft(e.target.value)}
                                            rows="7"
                                            className="w-full bg-black/30 border border-gray-700 rounded-2xl p-4 text-gray-200 text-base"
                                            placeholder="Type here..."
                                        />
                                    </div>
                                    <div className="space-y-3">
                                        {personalScopedNotes.slice(0, 4).map(note => (
                                            <div key={note.id} className="bg-black/20 rounded-2xl p-4">
                                                <div className="flex items-center justify-between text-xs text-gray-500 mb-2">
                                                    <span>{formatNoteTime(note.timestamp)}</span>
                                                    <span className="px-2 py-1 rounded-full bg-gray-800 text-gray-300 border border-gray-700">{resolveNoteLinkLabel(note.linkedTo)}</span>
                                                </div>
                                                {note.tag && <div className="text-xs text-indigo-200 mb-2">{note.tag}</div>}
                                                <div className="text-gray-200 whitespace-pre-wrap">{note.content}</div>
                                            </div>
                                        ))}
                                        {personalScopedNotes.length === 0 && (
                                            <div className="text-gray-500">No personal or global notes yet.</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>

                {showDrawingModal && (
                    <div className="drawing-overlay" onClick={(e) => { if (e.target === e.currentTarget) closeDrawingModal(); }}>
                        <div className="drawing-panel">
                            <div className="flex items-center justify-between">
                                <h3 className="text-lg font-semibold text-gray-200">Draw Note</h3>
                                <button onClick={closeDrawingModal} className="text-gray-400 hover:text-gray-200 text-2xl">&times;</button>
                            </div>
                            <div className="drawing-toolbar">
                                {Object.entries(drawingTools).map(([key, tool]) => (
                                    <button
                                        key={key}
                                        onClick={() => setDrawingTool(key)}
                                        className={`tool-button ${drawingTool === key ? 'active' : ''}`}
                                        style={{ color: tool.color === '#ffffff' ? '#e5e7eb' : tool.color }}
                                    >
                                        {tool.label}
                                    </button>
                                ))}
                                <div className="flex-1" />
                                <button onClick={undoDrawing} className="tool-button">Undo</button>
                                <button onClick={clearDrawing} className="tool-button">Clear</button>
                            </div>
                            <div className="drawing-modal-body">
                                <canvas
                                    ref={canvasRef}
                                    className="drawing-canvas"
                                    onPointerDown={startDrawing}
                                    onPointerMove={continueDrawing}
                                    onPointerUp={endDrawing}
                                    onPointerCancel={endDrawing}
                                    onPointerLeave={endDrawing}
                                />
                                <div className="w-full flex items-center gap-3">
                                    <input
                                        type="text"
                                        value={drawingTag}
                                        onChange={(e) => setDrawingTag(e.target.value)}
                                        placeholder="Tag (optional)..."
                                        className="flex-1 bg-black/30 border border-gray-700 rounded-xl px-3 py-2 text-sm text-gray-200"
                                    />
                                    <select
                                        value={drawingLinkedTo ?? ""}
                                        onChange={(e) => setDrawingLinkedTo(e.target.value || null)}
                                        className="bg-black/30 border border-gray-700 rounded-xl px-3 py-2 text-sm text-gray-200"
                                    >
                                        <option value="">Global</option>
                                        <option value="personal">Personal</option>
                                        {clientsData.map(client => (
                                            <option key={client.id} value={client.id}>{client.name}</option>
                                        ))}
                                    </select>
                                    <button
                                        onClick={saveDrawingNote}
                                        className="px-5 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-sm font-medium"
                                    >
                                        Save Drawing
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {expandedDrawing && (
                    <div className="image-overlay" onClick={(e) => { if (e.target === e.currentTarget) setExpandedDrawing(null); }}>
                        <div className="image-panel">
                            <div className="flex items-center justify-between mb-3">
                                <span className="text-gray-300">{expandedDrawing.tag || 'Drawing'}</span>
                                <button onClick={() => setExpandedDrawing(null)} className="text-gray-400 hover:text-gray-200 text-2xl">&times;</button>
                            </div>
                            <img src={expandedDrawing.drawingData} alt="Drawing" className="w-full max-h-[80vh] object-contain rounded-2xl bg-white" />
                        </div>
                    </div>
                )}
            );
        }
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
